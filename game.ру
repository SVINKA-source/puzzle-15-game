import random


class Puzzle15:
    def __init__(self):
        # –°–æ–∑–¥–∞–µ–º —Ä–µ—à–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –µ–≥–æ
        self.board = [i for i in range(1, 16)] + [0]
        self.empty_pos = 15  # –ü–æ–∑–∏—Ü–∏—è –ø—É—Å—Ç–æ–π –∫–ª–µ—Ç–∫–∏ (0-15)
        self.shuffle()

    def shuffle(self):
        """–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç –ø–æ–ª–µ"""
        random.shuffle(self.board)
        self.empty_pos = self.board.index(0)

    def display(self):
        """–í—ã–≤–æ–¥–∏—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—è"""
        print("\n" + "=" * 20)
        for i in range(0, 16, 4):
            row = self.board[i:i + 4]
            print(" | ".join(f"{num:2}" if num != 0 else "  " for num in row))
            if i < 12:
                print("-" * 20)
        print("=" * 20)

    def is_solved(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ä–µ—à–µ–Ω–∞ –ª–∏ –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞"""
        return self.board == [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0]

    def get_valid_moves(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤"""
        moves = []
        row, col = self.empty_pos // 4, self.empty_pos % 4

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —á–µ—Ç—ã—Ä–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        if row > 0: moves.append(self.empty_pos - 4)  # –í–≤–µ—Ä—Ö
        if row < 3: moves.append(self.empty_pos + 4)  # –í–Ω–∏–∑
        if col > 0: moves.append(self.empty_pos - 1)  # –í–ª–µ–≤–æ
        if col < 3: moves.append(self.empty_pos + 1)  # –í–ø—Ä–∞–≤–æ

        return moves

    def move(self, number):
        """–ü–µ—Ä–µ–º–µ—â–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–ª–∏—Ç–∫—É –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ"""
        if number not in self.board:
            print("–¢–∞–∫–æ–≥–æ —á–∏—Å–ª–∞ –Ω–µ—Ç –Ω–∞ –ø–æ–ª–µ!")
            return False

        pos = self.board.index(number)
        if pos in self.get_valid_moves():
            # –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –ø–ª–∏—Ç–∫—É –∏ –ø—É—Å—Ç—É—é –∫–ª–µ—Ç–∫—É
            self.board[self.empty_pos], self.board[pos] = self.board[pos], self.board[self.empty_pos]
            self.empty_pos = pos
            return True
        else:
            print("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —ç—Ç—É –ø–ª–∏—Ç–∫—É!")
            return False

    def play(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª"""
        print("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É '15'!")
        print("–ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –ø–ª–∏—Ç–∫–∏, —á—Ç–æ–±—ã —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å —á–∏—Å–ª–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É.")
        print("–î–ª—è —Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 15.")
        print("–î–ª—è –≤—ã—Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ 'q'")

        while True:
            self.display()

            if self.is_solved():
                print("\nüéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —Ä–µ—à–∏–ª–∏ –≥–æ–ª–æ–≤–æ–ª–æ–º–∫—É!")
                break

            user_input = input("\n–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è: ").strip().lower()

            if user_input == 'q':
                print("–í—ã—Ö–æ–¥ –∏–∑ –∏–≥—Ä—ã.")
                break

            try:
                number = int(user_input)
                if 1 <= number <= 15:
                    self.move(number)
                else:
                    print("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 15!")
            except ValueError:
                print("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥! –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞.")


if __name__ == "__main__":
    game = Puzzle15()
    game.play()
